<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="login.css"/>
</head>
<body>
<div id="app">
    <div class="container">
        <div class="wrapper">
            <h2>QG技术论坛：{{way}}</h2>
            <br>

            <!-- 注册表单 -->
            <div class="form-panel" :class="{active: isLogin && !showForgotPassword}">
                <form action="/register" method="post" @submit.prevent="submitCheck">
                    <label>手机号：
                        <input type="text" v-model="setPhone">
                        <span class="error">{{ errors.setPhone }}</span>
                    </label>
                    <label>邮箱：
                        <input type="text" v-model="setEmail" maxlength="20">
                        <span class="error">{{ errors.setEmail }}</span>
                    </label>
                    <label>姓名：
                        <input type="text" v-model="setName" maxlength="11">
                        <span class="error">{{ errors.setName }}</span>
                    </label>
                    <label>身份证号：
                        <input type="text" v-model="setIdNumber">
                        <span class="error">{{ errors.setIdNumber}}</span>
                    </label>
                    <label>密码：
                        <input type="password" v-model="setPassword" maxlength="15">
                        <span class="error">{{ errors.setPassword }}</span>
                    </label>
                    <label>确认密码：
                        <input type="password" v-model="setPasswordAgain" maxlength="15">
                        <span class="error">{{ errors.setPasswordAgain }}</span>
                    </label>
                    <label v-if="showVerifyCode || isLogin" class="verify-code-group">
                        验证码：
                        <input type="text" v-model="verifyCode">
                        <img :src="'/other/getHorse?' + timestamp" @click="refreshHorse" class="verify-code-img">
                        <span class="error">{{ errors.verifyCode }}</span>
                    </label>
                </form>
            </div>

            <!-- 修改密码表单 -->
            <div class="form-panel" :class="{active: showForgotPassword}">
                <form @submit.prevent="submitChangePassword">
                    <label>手机号/邮箱：
                        <input type="text" v-model="forgotAccount" maxlength="20">
                        <span class="error">{{ errors.forgotAccount }}</span>
                    </label>
                    <label>新密码：
                        <input type="password" v-model="newPassword" maxlength="15">
                        <span class="error">{{ errors.newPassword }}</span>
                    </label>
                    <label>确认新密码：
                        <input type="password" v-model="confirmNewPassword" maxlength="15">
                        <span class="error">{{ errors.confirmNewPassword }}</span>
                    </label>
                </form>
            </div>

            <!-- 登录表单 -->
            <div class="form-panel" :class="{active: !isLogin && !showForgotPassword}">
                <form action="/login" method="post" @submit.prevent="submitCheck">
                    <label>手机号/邮箱：
                        <input type="text" v-model="loginAccount">
                        <span class="error">{{ errors.loginAccount }}</span>
                    </label>
                    <label>登录密码：
                        <input type="password" v-model="loginPassword">
                        <span class="error">{{ errors.loginPassword }}</span>
                    </label>
                    <label v-if="showVerifyCode || isLogin" class="verify-code-group">
                        验证码：
                        <input type="text" v-model="verifyCode">
                        <img :src="'/other/getHorse?' + timestamp" @click="refreshHorse" class="verify-code-img">
                        <span class="error">{{ errors.verifyCode }}</span>
                    </label>
                    <h5 @click="forgetPassword" style="text-align: right;">忘记密码</h5>
                </form>
            </div>

            <br>
            <button class="button" @click="showForgotPassword ? submitChangePassword() : submitCheck()">
                {{ showForgotPassword ? '确认修改' : (isLogin ? '完成注册' : '立即登录') }}
            </button>
            <br>
            <h4 @click="turnWay">{{turn}}</h4>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: () => ({
            isLogin: false,
            way: '登录',
            turn: "还没有账号？点我注册",
            setPassword: '',
            setPasswordAgain: '',
            setPhone: '',
            setEmail: '',
            setIdNumber: '',
            setName: "",
            loginAccount: '',
            loginPassword: '',
            errors: {},
            showForgotPassword: false,
            forgotAccount: '',
            newPassword: '',
            confirmNewPassword: '',
            horse: '',
            timestamp: Date.now(),
            verifyCode: '',
            errorCount: 0,
            showVerifyCode: false,
            hadLogin: false
        }),
        mounted() {
            axios.post('/other/exitLogin');
        },
        methods: {
            // 公共方法
            refreshHorse() {
                this.timestamp = Date.now();
            },
            handleResponseError(error) {
                if (error.response?.data.error) {
                    alert(error.response.data.error);
                    this.errorCount++;
                    if (this.errorCount >= 3) {
                        this.showVerifyCode = true;
                        this.refreshHorse();
                    }
                }
            },

            // 表单切换
            turnWay() {
                if (this.showForgotPassword) {
                    this.showForgotPassword = false;
                    this.way = '登录';
                    this.isLogin = false;
                    this.turn = "还没有账号？点我注册";
                    return;
                }
                this.isLogin = !this.isLogin;
                this.way = this.isLogin ? '注册' : '登录';
                this.turn = this.isLogin ? "回到登录" : "还没有账号？点我注册";
                this.refreshHorse();
            },

            // 验证逻辑
            validateVerifyCode() {
                if (!this.verifyCode) {
                    this.errors.verifyCode = '!!!验证码错误';
                    return false;
                }
                return true;
            },
            validatePhone(phone) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                return phoneRegex.test(phone);
            },
            validateEmail(email) {
                const emailRegex = /^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/;
                return emailRegex.test(email);
            },

            // 提交处理
            async submitCheck() {
                this.errors = {};
                let ifSuccess = true;

                if (this.isLogin) {
                    // 注册验证
                    ifSuccess = this.validateRegistration(ifSuccess);
                } else {
                    // 登录验证
                    ifSuccess = this.validateLogin(ifSuccess);
                }

                if (ifSuccess) {
                    this.handleSubmit();
                } else {
                    this.refreshHorse();
                }
            },

            validateRegistration(ifSuccess) {
                if (!this.validateVerifyCode()) ifSuccess = false;
                if (!this.setIdNumber) {
                    this.errors.setIdNumber = '!!!请输入身份证号';
                    ifSuccess = false;
                }
                // 其他字段验证...
                return ifSuccess;
            },

            validateLogin(ifSuccess) {
                if (this.errorCount >= 3 && !this.validateVerifyCode()) ifSuccess = false;
                if (!this.loginAccount) {
                    this.errors.loginAccount = '!!!请输入手机号/邮箱';
                    ifSuccess = false;
                }
                // 其他字段验证...
                return ifSuccess;
            },

            async handleSubmit() {
                try {
                    if (this.isLogin) {
                        const response = await axios.post('/other/register', new URLSearchParams({/* 参数 */}));
                        if (response.data.success) {
                            alert('注册成功！');
                            this.turnWay();
                        }
                    } else {
                        const response = await axios.post('/other/login', new URLSearchParams({/* 参数 */}));
                        if (response.data.code === 200) {
                            window.location.href = response.data.message === "admin"
                                ? 'adminLogin.html'
                                : 'studentLogin.html';
                        }
                    }
                } catch (error) {
                    this.handleResponseError(error);
                }
            },

            // 修改密码
            async submitChangePassword() {
                this.errors = {};
                let ifSuccess = true;

                if (!this.forgotAccount) {
                    this.errors.forgotAccount = '!!!请输入手机号/邮箱';
                    ifSuccess = false;
                }
                // 其他验证...

                if (ifSuccess) {
                    try {
                        const response = await axios.post('/other/forget', new URLSearchParams({/* 参数 */}));
                        if (response.data.success) {
                            alert('密码修改成功！');
                            this.showForgotPassword = false;
                        }
                    } catch (error) {
                        this.handleResponseError(error);
                    }
                }
            },

            forgetPassword() {
                this.showForgotPassword = true;
                this.way = '修改密码';
                this.turn = "回到登录";
            }
        }
    })
</script>
</body>
</html>