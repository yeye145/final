<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>QGæŠ€æœ¯è®ºå›</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="homepage.css"/>
    <link rel="stylesheet" href="myself.css"/>
    <link rel="stylesheet" href="board.css"/>
    <link rel="stylesheet" href="post.css"/>
    <!-- å¼•å…¥ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
</head>
<body>
<div id="app">
    <input
            type="file"
            ref="fileInput"
            @change="handleAvatarUpload"
            accept="image/*"
            style="display: none;"
    >
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-bar">
        <div class="current-location">
            {{ currentPath.join(' > ') }}
        </div>
        <div class="avatar"
             @click="turnMyInformation"
             @mouseenter="ifShowDropdown = true"
             @mouseleave="ifShowDropdown = false"
        >
            <img :src="avatar" class="avatar-img" alt="å¤´åƒ">
            <div class="avatar-dropdown"
                 v-if="ifShowDropdown"
                 @mouseenter="ifShowDropdown = true"
                 @mouseleave="ifShowDropdown = false"
            >
                <div class="dropdown-item" @click="turnMyInformation">ä¸ªäººä¿¡æ¯</div>
                <div class="dropdown-item" @click="">ä¸¾æŠ¥ç”¨æˆ·</div>
                <div class="dropdown-item" @click="">ä¸¾æŠ¥å¸–å­</div>
                <div class="dropdown-item" @click="exitLogin">é€€å‡ºç™»å½•</div>
            </div>
        </div>
    </div>

    <!-- å·¦ä¾§åŠŸèƒ½å¯¼èˆª -->
    <div class="left-column">
        <h2 style="text-align: center;">â€”â€”åŠŸèƒ½å¯¼èˆªâ€”â€”</h2>
        <hr>
        <div class="nav-item" @click="backHomePage">ğŸ  å›åˆ°ä¸»é¡µ</div>
        <div class="nav-item" @click="turnAllBoard">ğŸ§© å…¨éƒ¨ç‰ˆå—</div>
        <hr>
    </div>

    <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
    <div class="right-column">
        <!-- ä¸»é¡µå†…å®¹ -->
        <div v-if="ifHomePage" class="content-section">
            <h3>ğŸ“Œ æœ€æ–°å…¬å‘Š</h3>
            <p>æ¬¢è¿æ¥åˆ°QGæŠ€æœ¯è®ºå›ï¼è¿™é‡Œæœ‰æœ€æ–°æŠ€æœ¯åŠ¨æ€å’Œæ·±åº¦è®¨è®ºã€‚</p>
        </div>

        <!--ç‰ˆå—å…¬å‘Šå†…å®¹-->
        <div class="content-section" v-if="ifBoardNotice">
            <h3>ğŸ“Œ å…¬å‘Š
                <button @click="showHistoryModal = true" class="history-btn">æŸ¥çœ‹å†å²å…¬å‘Š</button>
                <button v-if="ifMyBoard"
                        @click="showEditNewNoticeModal" class="create-board-btn">+ å‘å¸ƒæ–°çš„å…¬å‘Š
                </button>
            </h3>
            <p class="notice-content">{{ currentNotice.content }}</p>
            <p class="notice-time">ğŸ“… å‘å¸ƒæ—¶é—´ï¼š{{ currentNotice.time }}</p>
            <!-- å†å²å…¬å‘Šå¼¹çª— -->
            <div v-if="showHistoryModal" class="modal">
                <!--ç‚¹å‡»å¤–ä¾§åŒºåŸŸå…³é—­å¼¹çª—-->
                <div v-if="showHistoryModal" class="modal" @click.self="showHistoryModal = false">
                    <div class="modal-content">
                        <h3>å†å²å…¬å‘Šï¼ˆç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸä»¥å…³é—­ï¼‰</h3>
                        <div class="history-notice-list">
                            <div v-for="(eachNotice, index) in notice"
                                 @click="switchNotice(index)"> <!-- ç‚¹å‡»åˆ‡æ¢ -->
                                <span>ğŸ“… {{ eachNotice.time }}</span>
                                <p>{{ eachNotice.content }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨éƒ¨ç‰ˆå— -->
        <div v-if="ifAllBoard" class="profile-section">
            <div class="board-list" v-if="!ifAllPostInThisBoard">
                <div class="search-bar">
                    <input type="text" v-model="boardSearchQuery"
                           placeholder="è¾“å…¥ç‰ˆä¸»æ˜µç§°æˆ–ç‰ˆå—åç§°ä»¥æœç´¢"
                           @input="searchBoard">
                </div>
                <div class="filter-buttons">
                    <button @click="fetchNewBoard" class="filter-btn">æœ€æ–°ç‰ˆå—</button>
                    <button @click="fetchHotBoard" class="filter-btn">æœ€çƒ­é—¨ç‰ˆå—</button>
                </div>
                <div v-for="board in allBoard" :key="board.id" class="board-item">
                    <div class="board-info" @click="turnAllPostInThisBoard(board.id, board.title)">
                        <img :src="board.hostAvatar" class="host-avatar">
                        <h4>{{ board.title }}</h4>
                        <p>ç±»å‹: {{ board.type }} | å¸–å­æ•°: {{ board.postCount }} | æµè§ˆæ•°: {{ board.viewCount }}</p>
                        <p>ç‰ˆä¸»: {{board.hostName}} | åˆ›å»ºæ—¶é—´ï¼š{{ board.time }}</p>
                    </div>
                </div>
            </div>
            <div class="post-list" v-if="ifAllPostInThisBoard">
                <div class="search-bar">
                    <input type="text" v-model="postSearchQuery"
                           placeholder="è¾“å…¥å‘å¸–ç”¨æˆ·æ˜µç§°æˆ–å¸–å­åç§°ä»¥æœç´¢"
                           @input="searchPost">
                </div>
                <!--æ¸²æŸ“å…¨éƒ¨å¸–å­ä¿¡æ¯ï¼Œç‚¹å‡»å¸–å­åˆ‡æ¢åˆ°å¯¹åº”å¸–å­å†…å®¹-->
                <div v-for="post in allPostInThisBoard"
                     :key="post.id"
                     class="post-card"
                     @click="turnThisPost(post.id, post.title)">
                    <!--æ˜¾ç¤ºå¸–å­ä¿¡æ¯-->
                    <div class="post-meta">
                        <img :src="post.authorAvatar" class="author-avatar">
                        <span class="author">ğŸ‘¤ {{ post.authorName }}</span>
                        <span class="time">ğŸ“… {{ post.time }}</span>
                    </div>
                    <h4 class="post-title">{{ post.title }}</h4>
                    <div class="post-stats">
                        <span>â¤ï¸ {{ post.likeCount }}</span>
                        <span>ğŸ’¬ {{ post.commentCount }}</span>
                        <span>ğŸ‘€ {{ post.viewCount }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!--å¸–å­å…·ä½“å†…å®¹-->
        <div v-if="ifThisPost" class="post-detail-section">
            <!-- å¸–å­æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
            <div class="post-header">
                <h2 class="post-title">{{ thisPost.title }}</h2>
                <div class="post-meta">
                    <img :src="thisPost.authorAvatar" class="author-avatar">
                    <span class="author">ğŸ‘¤ {{ thisPost.authorName }}</span>
                    <span class="time">ğŸ“… {{ thisPost.time }}</span>
                    <span class="views">ğŸ‘€ {{ thisPost.viewCount }} æµè§ˆ</span>
                    <span class="likes">â¤ï¸ {{ thisPost.likeCount }} ç‚¹èµ</span>
                    <button class="like-collect-item"
                            @click="likePost(thisPost.id);
                            thisPost.likeCount = thisPost.likeCount + 1">ğŸ‘ ç‚¹èµ
                    </button>
                    <button class="like-collect-item"
                            @click="handleCollectClick(thisPost.id)"
                            :class="{ 'collected': thisPost.ifHadCollected }">
                        {{ thisPost.ifHadCollected ? 'â­ å·²æ”¶è—' : 'â­ æ”¶è—' }}
                    </button>
                </div>
            </div>

            <!-- æ°´å¹³åˆ†å‰²çº¿ -->
            <hr class="post-divider">

            <!-- å¸–å­å†…å®¹(Markdownæ¸²æŸ“åŒºåŸŸ) -->
            <div class="post-content markdown-body" v-html="compiledMarkdown"></div>

            <!-- æ°´å¹³åˆ†å‰²çº¿ -->
            <hr class="post-divider">

            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="comment-section">
                <h3>è¯„è®º ({{ thisPost.commentCount }})</h3>

                <!-- è¯„è®ºè¾“å…¥æ¡† -->
                <div class="comment-input">
                    <textarea v-model="newComment" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                    <button @click="submitComment">å‘è¡¨è¯„è®º</button>
                </div>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div class="comment-list">
                    <div v-for="comment in allCommentInThisPost" :key="comment.id" class="comment-item">
                        <div class="comment-header">
                            <img :src="comment.userAvatar" class="comment-avatar">
                            <span class="comment-author">{{ comment.userName }}</span>
                            <span class="comment-time">{{ formatTime(comment.time) }}</span>
                        </div>
                        <div class="comment-content" v-html="renderMarkdown(comment.content)"></div>
                        <div class="comment-actions">
                            <button @click="likeComment(comment.id)">â¤ï¸ {{ comment.likeCount }}</button>
                            <button @click="showReplyBox(comment.id)">å›å¤</button>
                        </div>
                        <!-- å­è¯„è®ºåŒºåŸŸï¼šä½¿ç”¨é€’å½’ç»„ä»¶ -->
                        <div class="child-comments">
                            <comment-tree
                                    :comments="comment.childComment"
                                    :parent-name="comment.userName"
                                    :format-time="formatTime"
                                    :render-markdown="renderMarkdown"
                                    :like-comment="likeComment"
                                    :show-reply-box="showReplyBox"
                            ></comment-tree>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ä¸ªäººä¿¡æ¯ -->
        <div v-if="ifMyInformation" class="profile-section">
            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="profile-header">
                <!--å¤´åƒæ˜¾ç¤º-->
                <img :src="avatar" class="profile-avatar" alt="å¤´åƒ" @click="triggerAvatarFileInput">
                <div class="profile-meta">
                    <!--ç¼–è¾‘æ˜µç§°-->
                    <div class="name-edit-container">
                         <span v-if="!ifEditName" class="editable-name" @click="turnEditName">
                             æ˜µç§°ï¼š{{ userInformation.name }}
                            <span class="edit-icon">ğŸ–Š</span>
                         </span>
                        <input v-if="ifEditName"
                               type="text"
                               v-model="newName"
                               ref="nameInput"
                               @blur="saveName"
                               class="name-input">
                    </div>
                    <!--å…¶ä»–ä¿¡æ¯å±•ç¤º-->
                    <div class="user-level">ç­‰çº§ï¼šLv{{ userInformation.grade }}</div>
                    <div class="profile-stats">
                        <span>â¤ï¸ {{ userInformation.receiveLikeCount }} æ”¶è·ç‚¹èµ</span>
                        <span>ğŸ‘€ {{ userInformation.receiveReadCount }} è¢«é˜…è¯»æ•°</span>
                    </div>
                </div>
            </div>

            <!-- äº’åŠ¨æ•°æ®å¡ç‰‡ -->
            <div class="stats-grid">
                <!-- ç¬¬ä¸€è¡Œ -->
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“±</div>
                    <div class="stat-value">{{ userInformation.phone }}</div>
                    <div class="stat-label">æ‰‹æœºå·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“§</div>
                    <div class="stat-value">{{ userInformation.email }}</div>
                    <div class="stat-label">é‚®ç®±</div>
                </div>
                <div class="stat-card" @click="turnMyBoard">
                    <div class="stat-icon">ğŸ§©</div>
                    <div class="stat-value">{{userInformation.myBoardCount}}</div>
                    <div class="stat-label">æˆ‘çš„ç‰ˆå—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value">{{ userInformation.fansCount }}</div>
                    <div class="stat-label">æˆ‘çš„ç²‰ä¸</div>
                </div>

                <!-- ç¬¬äºŒè¡Œ -->
                <div class="stat-card" @click="turnMyHistory">
                    <div class="stat-icon">ğŸ•’</div>
                    <div class="stat-value">...</div>
                    <div class="stat-label">å†å²è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value">{{ userInformation.mySubscribeCount }}</div>
                    <div class="stat-label">æˆ‘çš„å…³æ³¨</div>
                </div>
                <div class="stat-card" @click="turnMyCollect">
                    <div class="stat-icon">â­</div>
                    <div class="stat-value">{{ userInformation.myCollectCount }}</div>
                    <div class="stat-label">æˆ‘çš„æ”¶è—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“–</div>
                    <div class="stat-value">{{ userInformation.postCount }}</div>
                    <div class="stat-label">æˆ‘çš„å¸–å­</div>
                </div>
            </div>

        </div>

        <!-- æˆ‘çš„ç‰ˆå— -->
        <div v-if="ifMyBoard" class="board-section">
            <div class="board-header">
                <h3>æˆ‘çš„ç‰ˆå—</h3>
                <button v-if="!ifAllPostInMyBoard"
                        @click="showCreateBoardModal = true"
                        class="create-board-btn">+ ç”³è¯·æ–°å¢ç‰ˆå—
                </button>
                <button v-if="ifAllPostInMyBoard && !ifDeleteMode"
                        @click="turnDeleteMode"
                        class="delete-post-btn">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤å¸–å­
                </button>
                <button v-if="ifDeleteMode"
                        @click="showDeletePostModal = true"
                        class="delete-post-btn">ç¡®è®¤åˆ é™¤å¸–å­
                </button>
            </div>


            <div class="board-list" v-if="!ifAllPostInMyBoard">
                <!--å±•ç¤ºæˆ‘ç®¡ç†çš„å…¨éƒ¨ç‰ˆå—-->
                <div v-for="board in myBoard" :key="board.id" class="board-item">
                    <div class="board-info" @click="turnAllPostInMyBoard(board.id, board.title)">
                        <h4>{{ board.title }}</h4>
                        <p>ç±»å‹: {{ board.type }} | å¸–å­æ•°: {{ board.postCount }} | æµè§ˆæ•°: {{ board.viewCount }}</p>
                        <p>åˆ›å»ºæ—¶é—´ï¼š{{ board.time }}</p>
                    </div>
                    <!--å°ç¦ç”¨æˆ·-->
                    <div class="board-actions">
                        <button @click="showBanModal(board.id)" class="ban-btn">å°ç¦ç”¨æˆ·</button>
                    </div>
                </div>
            </div>
            <div class="post-list" v-if="ifAllPostInMyBoard">
                <!--å¸–å­æœç´¢æ¡†-->
                <div class="search-bar">
                    <input type="text" v-model="postSearchQuery"
                           placeholder="è¾“å…¥å‘å¸–ç”¨æˆ·æ˜µç§°æˆ–å¸–å­åç§°ä»¥æœç´¢"
                           @input="searchPostInMyBoard">
                </div>
                <!--æ¸²æŸ“å¸–å­ä¿¡æ¯-->
                <div v-for="post in allPostInMyBoard"
                     :key="post.id"
                     class="post-card">
                    <div class="post-meta" @click="turnThisPost(post.id, post.title)">
                        <span class="author">ğŸ‘¤ {{ post.authorName }}</span>
                        <span class="time">ğŸ“… {{ post.time }}</span>
                    </div>
                    <h4 class="post-title" @click="turnThisPost(post.id, post.title)">{{ post.title }}</h4>
                    <div class="post-stats">
                        <span>â¤ï¸ {{ post.likeCount }}</span>
                        <span>ğŸ’¬ {{ post.commentCount }}</span>
                        <span>ğŸ‘€ {{ post.viewCount }}</span>
                    </div>
                    <!-- æ‰¹é‡åˆ é™¤å¸–å­å‹¾é€‰æ¡† -->
                    <div class="post-checkbox" v-if="ifDeleteMode">
                        <input type="checkbox"
                               v-model="deleteChosenPost"
                               :value="post.id">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ç‰ˆå—åŠŸèƒ½ -->
        <div v-if="showCreateBoardModal" class="modal">
            <div class="modal-content">
                <h3>ç”³è¯·æ–°å¢ç‰ˆå—</h3>
                <div class="form-group">
                    <label>æ ‡é¢˜:</label>
                    <input v-model="newBoard.title" type="text">
                </div>
                <div class="form-group">
                    <label>ç±»å‹:</label>
                    <input v-model="newBoard.type" type="text">
                </div>
                <div class="form-group">
                    <label>ç‰ˆå—å…¬å‘Š:</label>
                    <textarea v-model="newBoard.notice"></textarea>
                </div>
                <div class="modal-actions">
                    <button @click="createBoard">æäº¤ç”³è¯·</button>
                    <button @click="showCreateBoardModal = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç‰ˆå—å°ç¦ç”¨æˆ·åŠŸèƒ½ -->
        <div v-if="ifShowBanModal" class="modal">
            <div class="modal-content">
                <h3>å°ç¦ç”¨æˆ·</h3>
                <div class="form-group">
                    <label>ç”¨æˆ·å:</label>
                    <input v-model="banUser.username" type="text" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>å°ç¦åŸå› :</label>
                    <textarea v-model="banUser.reason" placeholder="è¾“å…¥å°ç¦åŸå› "></textarea>
                </div>
                <div class="modal-actions">
                    <button @click="banUserFromBoard">ç¡®è®¤å°ç¦</button>
                    <button @click="ifShowBanModal = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘å…¬å‘Šå¼¹çª— -->
        <div v-if="ifShowEditNewNoticeModal" class="modal">
            <div class="modal-content">
                <h3>ç¼–è¾‘å…¬å‘Š</h3>
                <div class="form-group">
                    <label>å…¬å‘Šå†…å®¹ï¼š</label>
                    <textarea v-model="newNotice.content" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹"></textarea>
                </div>
                <button @click="publishNewNotice">ä¿å­˜</button>
                <button @click="ifShowEditNewNoticeModal = false">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- å¤‡æ³¨æ”¶è—ä¿¡æ¯ -->
        <div v-if="ifShowEditCollectRemark" class="modal">
            <div class="modal-content">
                <h3>æ”¶è—</h3>
                <div class="form-group">
                    <label>æ”¶è—å¤‡æ³¨ï¼š</label>
                    <textarea v-model="newCollectRemark" placeholder="è¾“å…¥æ”¶è—çš„å¤‡æ³¨ä¿¡æ¯"></textarea>
                </div>
                <button @click="saveCollect">ä¿å­˜</button>
                <button @click="ifShowEditCollectRemark = false">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æˆ‘çš„ç‰ˆå—â€”â€”åˆ é™¤å¸–å­ç¡®è®¤å¼¹çª— -->
        <div v-if="showDeletePostModal" class="modal">
            <div class="modal-content">
                <h3>ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ {{ deleteChosenPost.length }} ç¯‡å¸–å­ï¼Ÿ</h3>
                <div class="modal-actions">
                    <button @click="confirmDeletePost" class="confirm-btn">ç¡®è®¤åˆ é™¤</button>
                    <button @click="showDeletePostModal = false; turnDeleteMode()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å†å²ç‰ˆå—â€”â€”æˆ‘çš„å†å²è®°å½• -->
        <div v-if="ifMyHistory" class="board-section">
            <div class="post-list">
                <!--å¸–å­æœç´¢æ¡†-->
                <div class="search-bar">
                    <input type="text" v-model="postSearchQuery"
                           placeholder="è¾“å…¥å‘å¸–ç”¨æˆ·æ˜µç§°ã€å¸–å­åç§°æˆ–æµè§ˆæ—¶é—´ä»¥æœç´¢"
                           @input="searchPostHistory">
                </div>
                <!--æ¸²æŸ“å¸–å­ä¿¡æ¯-->
                <div v-for="postHistory in myHistoryReadPost"
                     :key="postHistory.id"
                     class="post-card"
                     @click="turnThisPost(postHistory.post.id, postHistory.post.title)">
                    <div class="post-meta">
                        <span class="author">ğŸ‘¤ {{ postHistory.post.authorName }}</span>
                        <span class="time">ğŸ“… {{ postHistory.post.time }}</span>
                    </div>
                    <h4 class="post-title">{{ postHistory.post.title }}</h4>
                    <div class="post-stats">
                        <span>â¤ï¸ {{ postHistory.post.likeCount }}</span>
                        <span>ğŸ’¬ {{ postHistory.post.commentCount }}</span>
                        <span>ğŸ‘€ {{ postHistory.post.viewCount }}</span>
                    </div>
                    <span class="time">ğŸ’»æµè§ˆæ—¶é—´ {{ postHistory.time }}</span>
                </div>
            </div>
        </div>

        <!-- æ”¶è—ç‰ˆå—â€”â€”æˆ‘çš„æ”¶è—å¸–å­ -->
        <div v-if="ifMyCollect" class="board-section">
            <div class="post-list">
                <!--å¸–å­æœç´¢æ¡†-->
                <div class="search-bar">
                    <input type="text" v-model="postSearchQuery"
                           placeholder="è¾“å…¥å‘å¸–ç”¨æˆ·æ˜µç§°ã€å¸–å­åç§°æˆ–æµè§ˆæ—¶é—´ä»¥æœç´¢"
                           @input="searchPostCollect">
                </div>
                <!--æ¸²æŸ“å¸–å­ä¿¡æ¯-->
                <div v-for="postCollect in postCollect"
                     :key="postCollect.id"
                     class="post-card"
                     @click="turnThisPost(postCollect.post.id, postCollect.post.title)">
                    <div class="post-meta">
                        <span class="author">ğŸ‘¤ {{ postCollect.post.authorName }}</span>
                        <span class="time">ğŸ“… {{ postCollect.post.time }}</span>
                    </div>
                    <h4 class="post-title">{{ postCollect.post.title }}</h4>
                    <div class="post-stats">
                        <span>â¤ï¸ {{ postCollect.post.likeCount }}</span>
                        <span>ğŸ’¬ {{ postCollect.post.commentCount }}</span>
                        <span>ğŸ‘€ {{ postCollect.post.viewCount }}</span>
                    </div>
                    <span class="time">ğŸ’»æ”¶è—æ—¶é—´ï¼š {{ postCollect.time }} | ğŸ“šå¤‡æ³¨ï¼š {{ postCollect.remark }}</span>
                </div>
            </div>
        </div>

    </div>

</div>
<!--åŠ è½½axios-->
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<!--åŠ è½½vue-->
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>

<!-- åŠ è½½ marked -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    hljs.configure({
        ignoreUnescapedHTML: true
    });
    hljs.highlightAll();
</script>

<!--å¾ªç¯æ¸²æŸ“è¯„è®ºçš„ç»„ä»¶æ³¨å†Œ-->
<script>
    Vue.component('comment-tree', {
        // å®šä¹‰ç»„ä»¶æ¥æ”¶çš„å±æ€§
        props: [
            'comments',
            'parentName',
            'formatTime',
            'renderMarkdown',
            'likeComment',
            'showReplyBox'
        ],
        // å®šä¹‰ç»„ä»¶çš„æ¨¡æ¿
        template: `
          <div>
            <div v-for="child in comments" :key="child.id" class="child-comment">
              <div class="comment-header">
                <img :src="child.userAvatar" class="comment-avatar">
                <span class="comment-author">{{ child.userName }}</span>
                <!-- ä½¿ç”¨propsä¼ é€’çš„æ–¹æ³• -->
                <span class="comment-time">{{ formatTime(child.time) }}</span>
              </div>
              <!-- ä½¿ç”¨propsä¼ é€’çš„æ–¹æ³• -->
              <div class="comment-content" v-html="renderMarkdown('å›å¤ @' + parentName + 'ï¼š' + child.content)"></div>
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="comment-actions">
                <button @click.stop="likeComment(child.id)">â¤ï¸ {{ child.likeCount }}</button>
                <button @click.stop="showReplyBox(child.id)">å›å¤</button>
              </div>
              <!-- é€’å½’æ—¶ç»§ç»­ä¼ é€’æ–¹æ³•ï¼Œé€’å½’æ¸²æŸ“å­è¯„è®º -->
              <comment-tree
                  v-if="child.childComment && child.childComment.length"
                  :comments="child.childComment"
                  :parent-name="child.userName"
                  :format-time="formatTime"
                  :render-markdown="renderMarkdown"
                  :like-comment="likeComment"
                  :show-reply-box="showReplyBox"
              ></comment-tree>
            </div>
          </div>
        `
    });
</script>

<script>
    new Vue({
        el: '#app',
        data: {

            ifMyInformation: false,             // æ˜¾ç¤ºæˆ‘çš„ä¸ªäººä¿¡æ¯
            ifUploadMyAvatar: false,            // æ˜¯å¦ä¸Šä¼ æˆ‘çš„å¤´åƒ
            ifHomePage: true,                   // æ˜¾ç¤ºä¸»é¡µ
            ifEditName: false,                  // æ˜¯å¦ç¼–è¾‘æˆ‘çš„æ˜µç§°
            ifShowDropdown: false,              // æ˜¾ç¤ºå¤´åƒä¸‹æ‹‰é€‰é¡¹
            ifAllBoard: false,                  // æ˜¾ç¤ºæ‰€æœ‰ç‰ˆå—
            ifAllPostInThisBoard: false,        // æ˜¾ç¤ºè¯¥ç‰ˆå—æ‰€æœ‰å¸–å­
            ifAllPostInMyBoard: false,          // æ˜¾ç¤ºæˆ‘çš„ç‰ˆå—çš„æ‰€æœ‰å¸–å­
            ifThisPost: false,                  // æ˜¾ç¤ºè¯¥å¸–å­
            ifMyHistory: false,                 // æ˜¾ç¤ºæˆ‘çš„å†å²è®°å½•
            ifBoardNotice: false,               // æ˜¾ç¤ºç‰ˆå—å…¬å‘Š
            ifShowBanModal: false,              // æ˜¯å¦æ˜¾ç¤ºç”¨æˆ·å°ç¦æ¡†
            ifShowEditNewNoticeModal: false,    // æ˜¯å¦æ˜¾ç¤ºæ–°å¢å…¬å‘Šæ¡†
            ifMyBoard: false,                   // æ˜¯å¦æ˜¾ç¤ºæˆ‘çš„ç‰ˆå—
            ifMyCollect: false,                 // æ˜¯å¦æ˜¾ç¤ºæˆ‘çš„æ”¶è—
            ifDeleteMode: false,                // æ˜¯å¦è¿›å…¥å¸–å­åˆ é™¤æ¨¡å¼
            // ifHadCollected: false,              // æ–°å¢æ”¶è—çŠ¶æ€
            ifShowEditCollectRemark: false,     // æ˜¯å¦æ˜¾ç¤ºç¼–è¾‘æ”¶è—å¤‡æ³¨

            showHistoryModal: false,            // æ˜¯å¦æ˜¾ç¤ºå†å²å…¬å‘Šå¼¹çª—
            showDeletePostModal: false,         // æ˜¯å¦æ˜¾ç¤ºæ§åˆ¶åˆ é™¤å¼¹çª—
            showCreateBoardModal: false,
            currentBoardId: null,

            myBoard: [],
            allBoard: [],
            allPostInThisBoard: [],
            allPostInMyBoard: [],
            deleteChosenPost: [],               // å­˜å‚¨å¾…åˆ é™¤å¸–å­ID
            postCollect: [],                    // æ”¶è—çš„å¸–å­

            boardSearchQuery: '',               // ç‰ˆå—å…³é”®å­—æœç´¢
            originalAllBoard: [],
            postSearchQuery: '',                // å¸–å­å…³é”®å­—æœç´¢
            originalAllPostInThisBoard: [],
            originalAllPostInMyBoard: [],
            originalPostHistory: [],            // åŸå§‹å†å²è®°å½•å­˜å‚¨
            originalPostCollect: [],            // åŸå§‹æˆ‘çš„æ”¶è—å¸–å­

            notice: [],                         // å­˜å‚¨æ‰€æœ‰å…¬å‘Š
            currentNotice: {                    // å½“å‰å±•ç¤ºçš„å…¬å‘Š
                time: '',
                content: 'å½“å‰æš‚æ— å…¬å‘Š',
            },
            newBoard: {
                title: '',
                type: '',
                notice: ''
            },
            banUser: {
                username: '',
                reason: '',
                boardId: '',
            },
            newNotice: {
                content: '',
                boardId: '',
            },
            currentPath: ['QGæŠ€æœ¯è®ºå›', 'ä¸»é¡µ'],

            avatar: '/images/avatar/initAvatar.jpg',

            userInformation: {},
            newName: '',

            thisPost: {},                       // è®¿é—®æŸä¸ªå¸–å­
            allCommentInThisPost: [],           // è¯¥å¸–å­ä¸‹çš„æ‰€æœ‰è¯„è®º
            compiledMarkdown: '',               // å¸–å­å†…å®¹

            newComment: '',                     // æ–°çš„è¯„è®º
            newCollectRemark: '',               // æ–°å¢æ”¶è—å¤‡æ³¨

            myHistoryReadPost: [],              // æˆ‘çš„å†å²æµè§ˆè®°å½•


        },
        created() {
            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ç”¨æˆ·å¤´åƒ
            this.fetchUserAvatar();
            this.fetchUserInformation();
        },
        mounted() {

            // ç¡®ä¿åº“å·²åŠ è½½
            if (typeof hljs === 'undefined' || typeof marked === 'undefined') {
                console.error('åº“åŠ è½½å¤±è´¥!');
                return;
            }

            // é…ç½®marked
            marked.setOptions({
                breaks: true,
                highlight: function (code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, {language: lang}).value;
                        } catch (e) {
                            console.warn(`Failed to highlight ${lang} code:`, e);
                        }
                    }
                    return hljs.highlightAuto(code).value;
                }
            });

            // åˆå§‹é«˜äº®
            this.highlightAll();
        },
        methods: {
            // æ”¶è—å¸–å­çš„æœç´¢
            searchPostCollect() {
                if (this.postSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.postCollect = this.originalPostCollect;
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.postSearchQuery.toLowerCase();
                this.postCollect = this.originalPostCollect.filter(postCollection =>
                    // å°†åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«ä½œè€…åç§°æˆ–æ ‡é¢˜æˆ–æ—¶é—´ï¼Œåˆ™å‚¨å­˜
                    postCollection.post.authorName.toLowerCase().includes(query) ||
                    postCollection.post.title.toLowerCase().includes(query) ||
                    postCollection.time.toLowerCase().includes(query))
            },
            // åˆ‡æ¢æˆ‘çš„æ”¶è—
            turnMyCollect() {
                this.ifDeleteMode = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifEditName = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = false;
                this.ifAllPostInMyBoard = false;
                this.ifThisPost = false;
                this.ifBoardNotice = false;
                this.fetchCollect();
                this.ifMyHistory = false;
                this.ifMyCollect = true;
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æˆ‘çš„ä¿¡æ¯', 'æˆ‘çš„æ”¶è—'];
            },
            // è·å–æˆ‘çš„æ”¶è—
            fetchCollect() {
                let that = this;
                axios.post('/post/getCollect').then(response => {
                    if (response.data.code !== 200) {
                        console.log("çŠ¶æ€ç ï¼š" + response.data.code + response.data.message);
                        alert(response.data.message);
                    } else {
                        that.postCollect = response.data.data;
                        that.originalPostCollect = that.postCollect;
                        console.log(response.data.data);
                    }
                })
            },
            // å¤„ç†æ”¶è—ç‚¹å‡»
            handleCollectClick(postId) {
                if (this.thisPost.ifHadCollected) {
                    // å·²æ”¶è—çŠ¶æ€ï¼šç›´æ¥æ‰§è¡Œå–æ¶ˆæ”¶è—
                    this.cancelCollectPost(postId);
                } else {
                    // æœªæ”¶è—çŠ¶æ€ï¼šæ˜¾ç¤ºå¤‡æ³¨è¾“å…¥æ¡†
                    this.ifShowEditCollectRemark = true;
                    this.postId = postId; // å­˜å‚¨å½“å‰æ“ä½œçš„å¸–å­ID
                }
            },
            // ä¿å­˜æ”¶è—
            saveCollect() {
                axios.post('/post/collectThisPost', new URLSearchParams({
                    postId: this.postId,
                    remark: this.newCollectRemark,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        this.ifShowEditCollectRemark = false;
                        this.newCollectRemark = '';
                        // æ›´æ–°æ”¶è—çŠ¶æ€
                        this.thisPost.ifHadCollected = true;
                        // æ›´æ–°æ”¶è—æ•°
                        this.userInformation.myCollectCount++;
                        alert('æ”¶è—æˆåŠŸï¼');
                    }
                }).catch(error => {
                    alert('æ”¶è—å¤±è´¥: ' + error.message);
                });
            },
            // å–æ¶ˆæ”¶è—
            cancelCollectPost(postId) {
                axios.post('/post/cancelCollectThisPost', new URLSearchParams({
                    postId: postId,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        this.thisPost.ifHadCollected = false;
                        this.userInformation.myCollectCount--;
                        alert('å·²å–æ¶ˆæ”¶è—');
                    }
                });
            },
            // ä¸ºå¸–å­ç‚¹èµ
            likePost(postId) {
                axios.post('/post/likeThisPost', {
                    postId: postId,
                }, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        console.log(response.data);
                    } else {
                        alert(response.data.message);
                    }
                });
            },
            // åˆ‡æ¢åˆ é™¤æ¨¡å¼
            turnDeleteMode() {
                this.ifDeleteMode = !this.ifDeleteMode;
                this.deleteChosenPost = []; // é€€å‡ºåˆ é™¤æ¨¡å¼æ—¶æ¸…ç©ºå‹¾é€‰
            },
            // ç¡®è®¤åˆ é™¤å¸–å­
            confirmDeletePost() {
                if (this.deleteChosenPost.length === 0) {
                    alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¸–å­");
                    return;
                }
                axios.post('/post/deleteThesePost', {
                    postId: this.deleteChosenPost
                }, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        // åˆ é™¤æˆåŠŸååˆ·æ–°åˆ—è¡¨
                        this.fetchAllPostInMyBoard(this.currentBoardId, this.currentPath[this.currentPath.length - 1]);
                        this.deleteChosenPost = [];
                        this.ifDeleteMode = false;
                        this.showDeletePostModal = false;
                        alert("å¸–å­åˆ é™¤æˆåŠŸ");
                    } else {
                        alert("åˆ é™¤å¤±è´¥: " + response.data.message);
                    }
                }).catch(error => {
                    alert("è¯·æ±‚é”™è¯¯: " + error.message);
                });
            },
            // å†å²è®°å½•çš„æœç´¢
            searchPostHistory() {
                if (this.postSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.myHistoryReadPost = this.originalPostHistory;
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.postSearchQuery.toLowerCase();
                this.myHistoryReadPost = this.originalPostHistory.filter(postHistory =>
                    // å°†åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«ä½œè€…åç§°æˆ–æ ‡é¢˜æˆ–æ—¶é—´ï¼Œåˆ™å‚¨å­˜
                    postHistory.post.authorName.toLowerCase().includes(query) ||
                    postHistory.post.title.toLowerCase().includes(query) ||
                    postHistory.time.toLowerCase().includes(query))
            },
            // åˆ‡æ¢æˆ‘çš„å†å²
            turnMyHistory() {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifEditName = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = false;
                this.ifAllPostInMyBoard = false;
                this.ifThisPost = false;
                this.ifBoardNotice = false;
                this.fetchHistory();
                this.ifMyHistory = true;
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æˆ‘çš„ä¿¡æ¯', 'æµè§ˆå†å²'];
            },
            // è·å–æˆ‘çš„å†å²æµè§ˆè®°å½•
            fetchHistory() {
                let that = this;
                axios.post('/post/getHistory').then(response => {
                    if (response.data.code !== 200) {
                        console.log("çŠ¶æ€ç ï¼š" + response.data.code + response.data.message);
                        alert(response.data.message);
                    } else {
                        that.myHistoryReadPost = response.data.data;
                        that.originalPostHistory = that.myHistoryReadPost;
                        console.log(response.data.data);
                    }
                })
            },
            // è®¡å…¥æˆ‘çš„å†å²æµè§ˆè®°å½•
            recordHistory(post_id) {
                axios.post('/post/recordHistory', new URLSearchParams({
                    postId: post_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code !== 200) {
                        console.log("çŠ¶æ€ç ï¼š" + response.data.code + response.data.message);
                        alert(response.data.message);
                    } else {
                        console.log(response.data.data);
                    }
                })
            },
            // å›å¤è¾“å…¥
            showReplyBox(commentId) {
                // å®ç°å›å¤æ¡†æ˜¾ç¤ºé€»è¾‘
            },
            // æ—¶é—´æ ¼å¼åŒ–
            formatTime(time) {
                return new Date(time).toLocaleString();
            },
            // æäº¤è¯„è®º
            submitComment() {
                if (!this.newComment.trim()) {
                    alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                axios.post('/comment/create', new URLSearchParams({
                    postId: this.thisPost.id,
                    content: this.newComment
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        this.newComment = '';
                        this.fetchComments(this.thisPost.id);
                        this.thisPost.commentCount++;
                    }
                });
            },
            // ç‚¹èµè¯„è®º
            likeComment(commentId) {
                axios.post('/comment/like', new URLSearchParams({
                    commentId: commentId
                })).then(response => {
                    if (response.data.code === 200) {
                        const comment = this.allCommentInThisPost.find(c => c.id === commentId);
                        if (comment) comment.likeCount++;
                    }
                });
            },
            // è·å–è¯¥å¸–å­çš„æ‰€æœ‰è¯„è®º
            fetchComment(post_id) {
                axios.post('/comment/getAllCommentInThisPost', new URLSearchParams({
                    postId: post_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        this.allCommentInThisPost = response.data.data;
                    }
                }).catch(error => {
                    console.error("è·å–è¯„è®ºå¤±è´¥", error);
                });
            },
            // æ¸²æŸ“ Markdown å†…å®¹
            renderMarkdown(content) {
                if (typeof marked === 'undefined') {
                    console.error('marked is not available');
                    return content;
                }
                const html = marked.parse(content || '');
                this.$nextTick(() => {
                    // æ¸²æŸ“åé‡æ–°é«˜äº®
                    this.highlightAll();
                });
                return html;
            },
            // é«˜äº®æ‰€æœ‰ä»£ç å—
            highlightAll() {
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            },
            // æ˜¾ç¤ºæŸä¸ªå…·ä½“å¸–å­
            turnThisPost(post_id, post_title) {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifEditName = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = false;
                this.ifAllPostInMyBoard = false;
                this.ifMyHistory = false;
                this.ifThisPost = true;
                this.fetchThisPost(post_id, post_title);        // æŠ“å–è¿™ä¸ªå¸–å­çš„ä¿¡æ¯
                this.fetchComment(post_id);                     // æŠ“å–æ‰€æœ‰è¯„è®º
                this.recordHistory(post_id);                    // è®¡å…¥å†å²è®°å½•
            },
            // è·å–å…¬å‘Š
            fetchNotice(board_id) {
                axios.post('/board/getNotice', new URLSearchParams({
                    boardId: board_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        this.notice = response.data.data;
                        // é»˜è®¤æ˜¾ç¤ºæœ€æ–°å…¬å‘Š
                        if (this.notice.length > 0) {
                            this.currentNotice = this.notice[0];
                        }
                    }
                })
                    .catch(error => {
                        console.error('è·å–å…¬å‘Šå¤±è´¥:', error);
                    });
            },
            // åˆ‡æ¢å…¬å‘Š
            switchNotice(index) {
                this.currentNotice = this.notice[index];
                this.showHistoryModal = false; // ç‚¹å‡»åå…³é—­å¼¹çª—
            },
            // æˆ‘çš„ç‰ˆå—ä¸­ï¼Œå¸–å­å…³é”®å­—æœ
            searchPostInMyBoard() {
                if (this.postSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.allPostInMyBoard = this.originalAllPostInMyBoard;
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.postSearchQuery.toLowerCase();
                this.allPostInMyBoard = this.originalAllPostInMyBoard.filter(post =>
                    // å°†åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«ä½œè€…åç§°æˆ–æ ‡é¢˜ï¼Œåˆ™å‚¨å­˜
                    post.authorName.toLowerCase().includes(query) ||
                    post.title.toLowerCase().includes(query))
            },
            // å…¨éƒ¨ç‰ˆå—ä¸­ï¼Œå¸–å­å…³é”®å­—æœç´¢ç‰ˆå—
            searchPost() {
                if (this.postSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.allPostInThisBoard = this.originalAllPostInThisBoard;
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.postSearchQuery.toLowerCase();
                this.allPostInThisBoard = this.originalAllPostInThisBoard.filter(post =>
                    // å°†åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«ä½œè€…åç§°æˆ–æ ‡é¢˜ï¼Œåˆ™å‚¨å­˜
                    post.authorName.toLowerCase().includes(query) ||
                    post.title.toLowerCase().includes(query))
            },
            // ç‰ˆå—å…³é”®å­—æœç´¢ç‰ˆå—
            searchBoard() {
                if (this.boardSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.allBoard = this.originalAllBoard;
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.boardSearchQuery.toLowerCase();
                this.allBoard = this.originalAllBoard.filter(board =>
                    // å°†è¯¾ç¨‹åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«è¿™ä¸ªè¯¾ç¨‹åç§°ï¼Œåˆ™å‚¨å­˜
                    board.hostName.toLowerCase().includes(query) ||
                    board.title.toLowerCase().includes(query))
            },
            // åˆ‡æ¢å›ä¸»é¡µ
            backHomePage() {
                this.ifBoardNotice = false;
                this.ifMyInformation = false;
                this.ifHomePage = true;
                this.ifUploadMyAvatar = false;
                this.ifEditName = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = false;
                this.ifAllPostInMyBoard = false;
                this.ifThisPost = false;
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'ä¸»é¡µ'];
            },
            // åˆ‡æ¢è¯¥ç‰ˆå—ä¸‹æ‰€æœ‰å¸–å­
            turnAllPostInThisBoard(board_id, board_title) {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = true;
                this.ifAllPostInMyBoard = false;
                this.ifAllPostInThisBoard = true;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifThisPost = false;
                this.ifMyHistory = false;
                this.fetchAllPostInThisBoard(board_id, board_title);
                this.fetchNotice(board_id);
            },
            // åˆ‡æ¢æˆ‘çš„ç‰ˆå—ä¸‹æ‰€æœ‰å¸–å­
            turnAllPostInMyBoard(board_id, board_title) {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = true;
                this.ifAllPostInMyBoard = true;
                this.ifAllPostInThisBoard = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifShowDropdown = false;
                this.ifThisPost = false;
                this.ifMyHistory = false;
                this.newNotice.boardId = board_id;
                this.currentBoardId = board_id;
                this.fetchAllPostInMyBoard(board_id, board_title);
                this.fetchNotice(board_id);
            },
            // åˆ‡æ¢æ‰€æœ‰ç‰ˆå—
            turnAllBoard() {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifEditName = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = true;
                this.ifAllPostInThisBoard = false;
                this.ifAllPostInMyBoard = false;
                this.ifThisPost = false;
                this.ifMyHistory = false;
                this.fetchAllBoard();
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æ‰€æœ‰ç‰ˆå—'];
            },
            // åˆ‡æ¢æˆ‘çš„ç‰ˆå—
            turnMyBoard() {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = false;
                this.ifAllPostInMyBoard = false;
                this.ifMyInformation = false;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifMyBoard = true;
                this.ifShowDropdown = false;
                this.ifThisPost = false;
                this.ifMyHistory = false;
                this.fetchMyBoard();
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æˆ‘çš„ä¿¡æ¯', 'æˆ‘çš„ç‰ˆå—'];
            },
            // åˆ‡æ¢ç¼–è¾‘æ˜µç§°
            turnEditName() {
                this.ifEditName = true;
                this.newName = this.userInformation.name;
                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                this.$nextTick(() => {
                    this.$refs.nameInput.focus();
                });
            },
            // ä¿å­˜ä¿®æ”¹çš„æ˜µç§°
            saveName() {
                if (this.newName.trim() === '') {
                    alert('æ˜µç§°ä¸èƒ½ä¸ºç©º');
                    this.newName = this.userInformation.name;
                    return;
                }
                if (this.newName === this.userInformation.name) {
                    this.ifEditName = false;
                    return;
                }
                let that = this;
                axios.post('/user/updateName', new URLSearchParams({
                    id: that.userInformation.id,
                    newName: that.newName
                }), {
                    // æ²¡è®¾ç½®çš„è¯ï¼Œåç«¯æ¥æ”¶å§‹ç»ˆä¸ºnull
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        that.userInformation.name = that.newName;
                        alert("æ›´æ”¹æ˜µç§°æˆåŠŸï¼")
                    } else {
                        alert(response.data.message);
                    }
                });
                that.ifEditName = false;
            },
            // åˆ‡æ¢æ˜¾ç¤ºæˆ‘çš„ä¸ªäººä¿¡æ¯
            turnMyInformation() {
                this.ifMyCollect = false;
                this.ifDeleteMode = false;
                this.ifBoardNotice = false;
                this.ifMyInformation = true;
                this.ifHomePage = false;
                this.ifUploadMyAvatar = false;
                this.ifMyBoard = false;
                this.ifShowDropdown = false;
                this.ifAllBoard = false;
                this.ifThisPost = false;
                this.ifMyHistory = false;
                this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æˆ‘çš„ä¿¡æ¯'];
            },
            // è·å–æˆ‘çš„ä¸ªäººä¿¡æ¯
            fetchUserInformation() {
                let that = this;
                axios.post('/user/information')
                    .then(response => {
                        if (response.data.code === 200) {
                            this.userInformation = response.data.data;
                        } else {
                            console.error('è·å–ä¸ªäººä¿¡æ¯å¤±è´¥:', response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('è¯·æ±‚é”™è¯¯:', error);
                    });
            },
            // è·å–æˆ‘çš„å¤´åƒ
            fetchUserAvatar() {
                axios.post('/user/avatar', {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                })
                    .then(response => {
                        if (response.data.code === 200) {
                            this.avatar = response.data.data;
                        } else {
                            console.error('è·å–å¤´åƒå¤±è´¥:', response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('è¯·æ±‚é”™è¯¯:', error);
                    });
            },
            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            triggerAvatarFileInput() {
                this.$refs.fileInput.click();
            },
            // æäº¤å¤´åƒä¸Šä¼ 
            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // éªŒè¯æ–‡ä»¶
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    alert('è¯·ä¸Šä¼ JPEGã€PNGæˆ–GIFæ ¼å¼çš„å›¾ç‰‡');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) {
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }

                // åˆ›å»ºé¢„è§ˆå¹¶ä¸Šä¼ 
                this.avatar = URL.createObjectURL(file);
                this.uploadAvatarToServer(file);
            },
            // ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨
            uploadAvatarToServer(file) {
                const formData = new FormData();
                formData.append('avatar', file);

                axios.post('/avatar/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                }).then(response => {
                    // ä¸Šä¼ æˆåŠŸ
                    if (response.data.code === 200) {
                        alert('å¤´åƒæ›´æ–°æˆåŠŸ: ' + response.data.data);
                        this.avatar = response.data.data;
                    } else {
                        // å¼¹çª—å¤±è´¥ä¿¡æ¯
                        alert('ä¸Šä¼ å¤±è´¥: ' + response.data.message);
                    }
                }).catch(error => {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                    const errorMessage = error.response?.data?.message || error.message;
                    alert('ä¸Šä¼ å¤±è´¥: ' + errorMessage);
                });
            },
            // è·å–æˆ‘çš„ç‰ˆå—
            fetchMyBoard() {
                axios.post('/board/getMyBoard')
                    .then(response => {
                        if (response.data.code === 200) {
                            this.myBoard = response.data.data;
                        }
                    })
                    .catch(error => {
                        console.error('è·å–ç‰ˆå—å¤±è´¥:', error);
                    });
            },
            // è·å–å…¨éƒ¨ç‰ˆå—
            fetchAllBoard() {
                axios.post('/board/getAllBoard')
                    .then(response => {
                        if (response.data.code === 200) {
                            this.allBoard = response.data.data;
                            this.originalAllBoard = this.allBoard;
                        }
                    })
                    .catch(error => {
                        console.error('è·å–ç‰ˆå—å¤±è´¥:', error);
                    });
            },
            // è·å–çƒ­é—¨ç‰ˆå—
            fetchHotBoard() {
                axios.post('/board/getHotBoard')
                    .then(response => {
                        if (response.data.code === 200) {
                            this.allBoard = response.data.data;
                            this.originalAllBoard = this.allBoard;
                        }
                    })
                    .catch(error => {
                        console.error('è·å–ç‰ˆå—å¤±è´¥:', error);
                    });
            },
            // è·å–æœ€æ–°ç‰ˆå—
            fetchNewBoard() {
                axios.post('/board/getNewBoard')
                    .then(response => {
                        if (response.data.code === 200) {
                            this.allBoard = response.data.data;
                            this.originalAllBoard = this.allBoard;
                        }
                    })
                    .catch(error => {
                        console.error('è·å–ç‰ˆå—å¤±è´¥:', error);
                    });
            },
            // è·å–è¯¥ç‰ˆå—ä¸‹çš„æ‰€æœ‰å¸–å­
            fetchAllPostInThisBoard(board_id, board_title) {
                axios.post('/post/getAllPostInThisBoard', new URLSearchParams({
                    boardId: board_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code !== 200) {
                        alert(response.data.message);
                    } else {
                        this.allPostInThisBoard = response.data.data;
                        this.originalAllPostInThisBoard = this.allPostInThisBoard;
                        this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'ç‰ˆå—ï¼š' + board_title, 'æ‰€æœ‰å¸–å­'];
                        console.log("è·å–ç‰ˆå—ï¼š" + board_title + "çš„æ‰€æœ‰å¸–å­æˆåŠŸ");
                    }
                })
                    .catch(error => {
                        console.error("è·å–ç‰ˆå—ï¼š" + board_title + "çš„æ‰€æœ‰å¸–å­å¤±è´¥", error);
                    });
            },
            // è·å–æˆ‘çš„ç‰ˆå—ä¸‹çš„æ‰€æœ‰å¸–å­
            fetchAllPostInMyBoard(board_id, board_title) {
                console.log("ç‰ˆå—idï¼š" + board_id + "ï¼Œç‰ˆå—åç§°ï¼š" + board_title);
                axios.post('/post/getAllPostInThisBoard', new URLSearchParams({
                    boardId: board_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code !== 200) {
                        alert(response.data.message);
                    } else {
                        this.allPostInMyBoard = response.data.data;
                        this.originalAllPostInMyBoard = this.allPostInMyBoard;
                        this.currentPath = ['QGæŠ€æœ¯è®ºå›', 'æˆ‘çš„ä¿¡æ¯', 'æˆ‘çš„ç‰ˆå—ï¼š' + board_title, 'æ‰€æœ‰å¸–å­'];
                        console.log("è·å–ç‰ˆå—ï¼š" + board_title + "çš„æ‰€æœ‰å¸–å­æˆåŠŸ");
                    }
                })
                    .catch(error => {
                        console.error("è·å–ç‰ˆå—ï¼š" + board_title + "çš„æ‰€æœ‰å¸–å­å¤±è´¥", error);
                    });
            },
            // è·å–è¯¥å¸–å­çš„æ‰€æœ‰å†…å®¹
            fetchThisPost(post_id, post_title) {
                axios.post('/post/getThisPost', new URLSearchParams({
                    postId: post_id,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code !== 200) {
                        alert(response.data.message);
                    } else {
                        this.thisPost = response.data.data;
                        // æ¸²æŸ“ Markdown å†…å®¹
                        this.compiledMarkdown = this.renderMarkdown(this.thisPost.content);
                        // æŠŠå½“å‰å¸–å­åŠ å…¥è·¯å¾„ä¸­æ˜¾ç¤ºåœ¨å·¦ä¸Šè§’
                        this.currentPath.push(post_title);
                        console.log("è·å–å¸–å­ï¼š" + post_title + "æˆåŠŸ");
                        this.checkIfHadCollect(post_id).then(isCollected => {
                            this.thisPost = {
                                ...this.thisPost,
                                ifHadCollected: isCollected
                            };
                        });
                    }
                })
                    .catch(error => {
                        console.error("è·å–å¸–å­ï¼š" + post_title + "å¤±è´¥", error);
                    });
                // ç¡®ä¿å†…å®¹æ¸²æŸ“åé«˜äº®
                this.$nextTick(() => {
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                });
            },
            // æ˜¾ç¤ºå°ç¦ç”¨æˆ·æ¨¡æ€æ¡†
            showBanModal(boardId) {
                this.banUser.boardId = boardId;
                this.ifShowBanModal = true;
            },
            // æ˜¾ç¤ºæ–°å…¬å‘Šç¼–è¾‘å‘å¸ƒæ¨¡æ€æ¡†
            showEditNewNoticeModal() {
                this.ifShowEditNewNoticeModal = true;
            },
            // åˆ›å»ºæ–°ç‰ˆå—
            createBoard() {
                if (!this.newBoard.title.trim()) {
                    alert('ç‰ˆå—æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                    return;
                }
                axios.post('/board/applyNewBoard', new URLSearchParams({
                    title: this.newBoard.title,
                    type: this.newBoard.type,
                    notice: this.newBoard.notice,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        alert('ç‰ˆå—ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸');
                        this.showCreateBoardModal = false;
                        this.fetchMyBoard();
                    } else {
                        alert(response.data.message);
                    }
                })
                    .catch(error => {
                        console.error('ç”³è¯·åˆ›å»ºç‰ˆå—å¤±è´¥:', error);
                        alert('ç”³è¯·åˆ›å»ºç‰ˆå—å¤±è´¥');
                    });
            },
            // å°ç¦ç”¨æˆ·
            banUserFromBoard() {
                if (!this.banUser.username.trim()) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·å');
                    return;
                }
                axios.post('/board/banUserInThisBoard', new URLSearchParams({
                    boardId: this.banUser.boardId,
                    userName: this.banUser.username,
                    reason: this.banUser.reason
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        alert('ç”¨æˆ·å·²å°ç¦');
                        this.showBanModal = false;
                        this.banUser = {username: '', reason: '', boardId: null};
                    } else {
                        alert(response.data.message);
                    }
                })
                    .catch(error => {
                        console.error('å°ç¦ç”¨æˆ·å¤±è´¥:', error);
                        alert('å°ç¦ç”¨æˆ·å¤±è´¥');
                    });
            },
            // æ–°å¢å…¬å‘Š
            publishNewNotice() {
                if (!this.newNotice.content.trim()) {
                    alert('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
                    return;
                }
                axios.post('/board/publishNewNotice', new URLSearchParams({
                    boardId: this.newNotice.boardId,
                    content: this.newNotice.content,
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        alert('å‘å¸ƒæˆåŠŸï¼');
                        this.ifShowEditNewNoticeModal = false;
                        this.fetchNotice(this.newNotice.boardId);
                        this.newNotice = {content: '', boardId: null};
                    } else {
                        alert(response.data.message);
                    }
                })
            },
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ”¶è—
            async checkIfHadCollect(postId) {
                try {
                    const response = await axios.post('/post/checkIfCollect', new URLSearchParams({
                        postId: postId,
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                    return response.data.data === "yes";
                } catch (error) {
                    console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            },
            // é€€å‡ºç™»å½•
            exitLogin() {
                axios.post('/login/exitLogin');
                window.location.href = '/login.html';
            },
        }

    })
</script>
</body>
</html>